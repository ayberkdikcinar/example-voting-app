version: '3.4'
services:

    db:
        image: postgres:9.4
        volumes:
            - "db-data:/var/lib/postgresql/data"
        networks:
            - instavote
        environment:
            - POSTGRES_HOST_AUTH_METHOD=trust

    redis:
        image: redis:alpine
        networks:
            - instavote

    worker:
        build: ./worker
        container_name: worker-app
        networks:
            - instavote
        depends_on:
            - redis
            - db
    vote:
        image: test12481248xenon/vote:dockerbuild
        container_name: vote_app
        ports:
            - 5001:80
        networks:
            - instavote
        depends_on:
            - redis
    result:
        image: test12481248xenon/result:v11
        container_name: result_app
        ports:
            - 5000:4000
        networks:
            - instavote
        depends_on:
            - db
    docker:
        image: docker:dind
        ports:
            - 2374:2376
            - 5001:5001
            - 5000:5000
        environment:
            - DOCKER_TLS_CERTDIR=/certs   
volumes:
    db-data:

networks:
    instavote:
        driver: bridge

        